{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user of the system with role-based access control (Admin).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "The email address of the user, used for login and communication.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The role of the user, which is always 'Admin' in this system.",
          "enum": [
            "Admin"
          ]
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the user account was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the user account was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "email",
        "role",
        "createdAt",
        "updatedAt"
      ]
    },
    "MedicineComposition": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "MedicineComposition",
      "type": "object",
      "description": "Represents the generic chemical composition of medicines, allowing for generic search and alternative suggestions.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the MedicineComposition entity (e.g., a composition ID)."
        },
        "name": {
          "type": "string",
          "description": "The common name of the chemical composition (e.g., 'Paracetamol', 'Ibuprofen')."
        },
        "description": {
          "type": "string",
          "description": "A detailed description or common uses of the composition."
        },
        "aiMatchApproved": {
          "type": "boolean",
          "description": "Indicates if an AI-suggested composition match has been reviewed and approved by an Admin."
        },
        "aiMatchSuggestion": {
          "type": "string",
          "description": "The AI tool's suggested composition name, if different from the entered one, awaiting Admin review."
        }
      },
      "required": [
        "id",
        "name",
        "aiMatchApproved"
      ]
    },
    "Medicine": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Medicine",
      "type": "object",
      "description": "Details of a specific medicine product, including pricing, units of measure, and reorder points. This acts as the inventory item.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Medicine entity."
        },
        "name": {
          "type": "string",
          "description": "Commercial brand name of the medicine (e.g., 'Crocin Advance', 'Saridon')."
        },
        "compositionId": {
          "type": "string",
          "description": "Reference to MedicineComposition. (Relationship: MedicineComposition 1:N Medicine)"
        },
        "category": {
          "type": "string",
          "description": "Category of the medicine (e.g., 'Painkiller', 'Antibiotic', 'Antacid')."
        },
        "company": {
          "type": "string",
          "description": "The pharmaceutical company or manufacturer of the medicine."
        },
        "storeBox": {
          "type": "string",
          "description": "Physical location or storage box identifier within the store (e.g., 'Shelf A-1', 'Drawer 3')."
        },
        "basePurchasePrice": {
          "type": "number",
          "description": "The standard purchase price per smallest unit of the medicine."
        },
        "baseSellingPrice": {
          "type": "number",
          "description": "The standard selling price per smallest unit of the medicine."
        },
        "tabletsPerStrip": {
          "type": "number",
          "description": "The number of tablets contained within one strip."
        },
        "stripsPerBox": {
          "type": "number",
          "description": "The number of strips contained within one box."
        },
        "reorderPoint": {
          "type": "number",
          "description": "The minimum stock threshold (in smallest units) at which a reorder alert is triggered."
        },
        "taxRateGst": {
          "type": "number",
          "description": "The GST (Goods and Services Tax) rate applicable to this medicine, as a percentage."
        },
        "imageUrl": {
          "type": "string",
          "description": "Optional URL to an image of the medicine product.",
          "format": "uri"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the medicine record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the medicine record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "compositionId",
        "category",
        "company",
        "basePurchasePrice",
        "baseSellingPrice",
        "reorderPoint",
        "taxRateGst",
        "createdAt",
        "updatedAt"
      ]
    },
    "Batch": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Batch",
      "type": "object",
      "description": "Manages individual batches of medicines, tracking expiry dates, quantities, and purchase details for FEFO management.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Batch entity."
        },
        "medicineId": {
          "type": "string",
          "description": "Reference to Medicine. (Relationship: Medicine 1:N Batch)"
        },
        "medicineName": {
            "type": "string",
            "description": "Denormalized name of the medicine for efficient lookups."
        },
        "batchNumber": {
          "type": "string",
          "description": "The manufacturer-assigned batch number for this specific production lot of medicine."
        },
        "expiryDate": {
          "type": "string",
          "description": "The expiry date of the medicine batch, crucial for FEFO and expiry alerts.",
          "format": "date"
        },
        "quantityInSmallestUnits": {
          "type": "number",
          "description": "The current quantity of medicine in this batch, expressed in the smallest measurable units."
        },
        "purchasePricePerSmallestUnit": {
          "type": "number",
          "description": "The cost price for each smallest unit of medicine in this specific batch when purchased."
        },
        "receivedAt": {
          "type": "string",
          "description": "Timestamp when this medicine batch was received into inventory.",
          "format": "date-time"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the batch record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the batch record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "medicineId",
        "medicineName",
        "batchNumber",
        "expiryDate",
        "quantityInSmallestUnits",
        "purchasePricePerSmallestUnit",
        "receivedAt",
        "createdAt",
        "updatedAt"
      ]
    },
    "Customer": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Customer",
      "type": "object",
      "description": "Represents a customer account managed by the admin, including their details and financial standing.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Customer entity, typically an admin-created ID."
        },
        "name": {
          "type": "string",
          "description": "The full name of the customer."
        },
        "phoneNumber": {
          "type": "string",
          "description": "The contact phone number of the customer."
        },
        "email": {
          "type": "string",
          "description": "The email address of the customer.",
          "format": "email"
        },
        "address": {
          "type": "string",
          "description": "The physical address of the customer."
        },
        "debtAmount": {
          "type": "number",
          "description": "The current outstanding debt amount owed by the customer."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the customer record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the customer record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "debtAmount",
        "createdAt",
        "updatedAt"
      ]
    },
    "CustomerAccountTransaction": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CustomerAccountTransaction",
      "type": "object",
      "description": "Records financial transactions related to a customer's account, such as payments or debt adjustments.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CustomerAccountTransaction entity."
        },
        "customerId": {
          "type": "string",
          "description": "Reference to Customer. (Relationship: Customer 1:N CustomerAccountTransaction)"
        },
        "transactionDate": {
          "type": "string",
          "description": "The date and time when the transaction occurred.",
          "format": "date-time"
        },
        "type": {
          "type": "string",
          "description": "The type of financial transaction (e.g., 'Payment', 'DebtAdjustment', 'SaleCharge')."
        },
        "amount": {
          "type": "number",
          "description": "The monetary amount of the transaction."
        },
        "paymentMethod": {
          "type": "string",
          "description": "The method of payment if applicable (e.g., 'Cash', 'UPI', 'Credit Card', 'Debt')."
        },
        "description": {
          "type": "string",
          "description": "A brief description or note about the transaction."
        },
        "relatedSaleId": {
          "type": "string",
          "description": "Optional reference to a Sale, if this transaction is directly related to a specific sale. (Relationship: Sale 1:N CustomerAccountTransaction)"
        },
        "createdByUserId": {
          "type": "string",
          "description": "Reference to User who recorded this customer account transaction. (Relationship: User 1:N CustomerAccountTransaction)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the customer account transaction record was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "customerId",
        "transactionDate",
        "type",
        "amount",
        "createdByUserId",
        "createdAt"
      ]
    },
    "Sale": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Sale",
      "type": "object",
      "description": "Records details of a customer purchase or bill, ensuring transactional integrity with stock levels.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Sale entity."
        },
        "saleDate": {
          "type": "string",
          "description": "The date and time when the sale occurred.",
          "format": "date-time"
        },
        "customerId": {
          "type": "string",
          "description": "Optional reference to Customer if the sale is linked to a customer account. (Relationship: Customer 1:N Sale)"
        },
        "totalAmountBeforeTax": {
          "type": "number",
          "description": "The total monetary amount of the sale before any taxes are applied."
        },
        "totalTaxAmount": {
          "type": "number",
          "description": "The total tax amount (e.g., GST) applied to the entire sale."
        },
        "totalAmountDue": {
          "type": "number",
          "description": "The final total monetary amount due for the sale, including all taxes."
        },
        "amountPaid": {
          "type": "number",
          "description": "The amount paid by the customer for this sale."
        },
        "balanceDue": {
          "type": "number",
          "description": "The remaining balance due for the sale (totalAmountDue - amountPaid)."
        },
        "paymentMethod": {
          "type": "string",
          "description": "The payment method used for the sale (e.g., 'Cash', 'UPI', 'Card', 'Debt')."
        },
        "invoiceNumber": {
          "type": "string",
          "description": "A unique invoice number generated for this sale."
        },
        "createdByUserId": {
          "type": "string",
          "description": "Reference to User (Admin) who processed this sale. (Relationship: User 1:N Sale)"
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the sale record was created.",
          "format": "date-time"
        },
        "updatedAt": {
          "type": "string",
          "description": "Timestamp when the sale record was last updated.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "saleDate",
        "totalAmountDue",
        "amountPaid",
        "balanceDue",
        "paymentMethod",
        "invoiceNumber",
        "createdByUserId",
        "createdAt",
        "updatedAt"
      ]
    },
    "SaleItem": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SaleItem",
      "type": "object",
      "description": "Details of a single medicine item included in a sale transaction, linking to the specific batch sold.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SaleItem entity."
        },
        "saleId": {
          "type": "string",
          "description": "Reference to Sale. (Relationship: Sale 1:N SaleItem)"
        },
        "medicineId": {
          "type": "string",
          "description": "Reference to Medicine. (Relationship: Medicine 1:N SaleItem)"
        },
        "batchId": {
          "type": "string",
          "description": "Reference to Batch, indicating which specific batch of the medicine was sold. (Relationship: Batch 1:N SaleItem)"
        },
        "quantitySold": {
          "type": "number",
          "description": "The quantity of medicine sold in this item, in its smallest units."
        },
        "unitSellingPrice": {
          "type": "number",
          "description": "The selling price per smallest unit of medicine at the time of sale."
        },
        "purchasePriceAtSale": {
          "type": "number",
          "description": "The purchase price per smallest unit from the batch at the time of sale, used for profit calculation."
        },
        "gstRateApplied": {
          "type": "number",
          "description": "The GST rate applied to this item at the time of sale, as a percentage."
        },
        "itemTotalBeforeTax": {
          "type": "number",
          "description": "The total price for this item before tax (quantitySold * unitSellingPrice)."
        },
        "itemTaxAmount": {
          "type": "number",
          "description": "The total tax amount for this specific item."
        },
        "itemTotalWithTax": {
          "type": "number",
          "description": "The final total price for this item including tax."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the sale item record was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "saleId",
        "medicineId",
        "batchId",
        "quantitySold",
        "unitSellingPrice",
        "gstRateApplied",
        "itemTotalBeforeTax",
        "itemTaxAmount",
        "itemTotalWithTax",
        "createdAt"
      ]
    },
    "StockAdjustmentLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "StockAdjustmentLog",
      "type": "object",
      "description": "An immutable log of all manual adjustments made to medicine stock for auditing and compliance.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the StockAdjustmentLog entity."
        },
        "medicineId": {
          "type": "string",
          "description": "Reference to Medicine whose stock was adjusted. (Relationship: Medicine 1:N StockAdjustmentLog)"
        },
        "batchId": {
          "type": "string",
          "description": "Optional reference to Batch, if a specific batch's stock was adjusted. (Relationship: Batch 1:N StockAdjustmentLog)"
        },
        "adjustmentDate": {
          "type": "string",
          "description": "The date and time when the stock adjustment occurred.",
          "format": "date-time"
        },
        "adjustmentType": {
          "type": "string",
          "description": "The type of adjustment (e.g., 'Manual Increase', 'Manual Decrease', 'Stocktake', 'ReturnToVendor', 'Sale')."
        },
        "oldQuantity": {
          "type": "number",
          "description": "The quantity of the medicine (in smallest units) before the adjustment."
        },
        "newQuantity": {
          "type": "number",
          "description": "The quantity of the medicine (in smallest units) after the adjustment."
        },
        "adjustedByUserId": {
          "type": "string",
          "description": "Reference to User who performed the stock adjustment. (Relationship: User 1:N StockAdjustmentLog)"
        },
        "reason": {
          "type": "string",
          "description": "A detailed reason for the stock adjustment (e.g., 'Damaged Packaging', 'Inventory Count Discrepancy')."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the audit log record was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "medicineId",
        "adjustmentDate",
        "adjustmentType",
        "oldQuantity",
        "newQuantity",
        "adjustedByUserId",
        "reason",
        "createdAt"
      ]
    },
    "PublicMedicineRequest": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "PublicMedicineRequest",
      "type": "object",
      "description": "Represents a medicine request submitted by a public, non-authenticated user from the website.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the PublicMedicineRequest entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the person requesting the medicine."
        },
        "contactNumber": {
          "type": "string",
          "description": "Contact phone number for the requester."
        },
        "place": {
          "type": "string",
          "description": "The city, town, or village of the requester."
        },
        "medicineName": {
          "type": "string",
          "description": "The name of the requested medicine and any other details."
        },
        "status": {
          "type": "string",
          "description": "The current status of the request.",
          "enum": [
            "Pending",
            "Contacted",
            "Fulfilled"
          ]
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp when the request was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "contactNumber",
        "place",
        "medicineName",
        "status",
        "createdAt"
      ]
    }
  },
  "auth": {
    "providers": [
      "password"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "User profiles with role (Admin). Used for authenticating users and determining their permissions via the 'role' field.",
          "params": [
            {
              "name": "userId",
              "description": "The unique ID of the user."
            }
          ]
        }
      },
      {
        "path": "/medicine_compositions/{compositionId}",
        "definition": {
          "entityName": "MedicineComposition",
          "schema": {
            "$ref": "#/backend/entities/MedicineComposition"
          },
          "description": "Generic chemical compositions of medicines, used for generic search. Only Admin can manage.",
          "params": [
            {
              "name": "compositionId",
              "description": "The unique ID of the medicine composition."
            }
          ]
        }
      },
      {
        "path": "/medicines/{medicineId}",
        "definition": {
          "entityName": "Medicine",
          "schema": {
            "$ref": "#/backend/entities/Medicine"
          },
          "description": "Details of specific medicine products. Includes denormalized 'compositionId' for generic search. Only Admin can manage.",
          "params": [
            {
              "name": "medicineId",
              "description": "The unique ID of the medicine."
            }
          ]
        }
      },
      {
        "path": "/batches/{batchId}",
        "definition": {
          "entityName": "Batch",
          "schema": {
            "$ref": "#/backend/entities/Batch"
          },
          "description": "Individual medicine batches, tracking expiry dates and quantities. Includes denormalized 'medicineId' for efficient lookup. Only Admin can manage.",
          "params": [
            {
              "name": "batchId",
              "description": "The unique ID of the medicine batch."
            }
          ]
        }
      },
      {
        "path": "/customers/{customerId}",
        "definition": {
          "entityName": "Customer",
          "schema": {
            "$ref": "#/backend/entities/Customer"
          },
          "description": "Customer accounts. Admin creates and manages these.",
          "params": [
            {
              "name": "customerId",
              "description": "The unique ID of the customer."
            }
          ]
        }
      },
      {
        "path": "/customers/{customerId}/transactions/{transactionId}",
        "definition": {
          "entityName": "CustomerAccountTransaction",
          "schema": {
            "$ref": "#/backend/entities/CustomerAccountTransaction"
          },
          "description": "Financial transactions related to a customer's account. Includes 'customerId' and 'createdByUserId' (Admin UID) for authorization. Only Admin can create transactions for existing customers.",
          "params": [
            {
              "name": "customerId",
              "description": "The unique ID of the parent customer."
            },
            {
              "name": "transactionId",
              "description": "The unique ID of the customer account transaction."
            }
          ]
        }
      },
      {
        "path": "/sales/{saleId}",
        "definition": {
          "entityName": "Sale",
          "schema": {
            "$ref": "#/backend/entities/Sale"
          },
          "description": "Records of customer purchases. Includes 'createdByUserId' (Admin UID) for authorization. Admin can manage all sales.",
          "params": [
            {
              "name": "saleId",
              "description": "The unique ID of the sale."
            }
          ]
        }
      },
      {
        "path": "/sales/{saleId}/sale_items/{saleItemId}",
        "definition": {
          "entityName": "SaleItem",
          "schema": {
            "$ref": "#/backend/entities/SaleItem"
          },
          "description": "Details of individual medicine items within a sale transaction. Includes denormalized 'saleId' and 'saleCreatedByUserId' (Admin UID) for authorization independence.",
          "params": [
            {
              "name": "saleId",
              "description": "The unique ID of the parent sale."
            },
            {
              "name": "saleItemId",
              "description": "The unique ID of the sale item."
            }
          ]
        }
      },
      {
        "path": "/stock_adjustment_logs/{logId}",
        "definition": {
          "entityName": "StockAdjustmentLog",
          "schema": {
            "$ref": "#/backend/entities/StockAdjustmentLog"
          },
          "description": "Immutable audit log of all manual stock adjustments. Includes 'adjustedByUserId' (Admin UID) for accountability. Read-only for Admin, write-only for the admin performing the adjustment.",
          "params": [
            {
              "name": "logId",
              "description": "The unique ID of the stock adjustment log entry."
            }
          ]
        }
      },
      {
        "path": "/public_medicine_requests/{requestId}",
        "definition": {
          "entityName": "PublicMedicineRequest",
          "schema": {
            "$ref": "#/backend/entities/PublicMedicineRequest"
          },
          "description": "Public-facing medicine requests. Anyone can create, only Admins can read/update.",
          "params": [
            {
              "name": "requestId",
              "description": "The unique ID of the medicine request."
            }
          ]
        }
      }
    ],
    "reasoning": "The proposed Firestore structure for 'Sateri Medical' prioritizes security, scalability, and debuggability by adhering to the core design principles, especially Authorization Independence and Structural Segregation. The design leverages top-level collections for universally accessible or globally managed entities and subcollections for tightly coupled transactional or itemized data. Authorization relies on a Role-Based Access Control (RBAC) model, where a user's role ('Admin') is stored in their respective `/users/{userId}` document. Security rules will fetch this role to determine read/write permissions across collections.\n\nAuthorization Independence is achieved primarily through denormalization. For subcollections that conceptually depend on a parent document's authorization context (e.g., `PurchaseOrderItem` needing the `PurchaseOrder`'s creator's permissions), the necessary authorization fields (like `createdByUserId` from the parent) are explicitly copied into each subcollection document (e.g., `purchaseOrderCreatedByUserId` in `PurchaseOrderItem`). This eliminates the need for `get()` calls in Firestore Security Rules to retrieve parent documents for authorization checks. This approach ensures that atomic operations (transactions/batches) involving parent and child documents remain secure and do not encounter `get()`-related rule evaluation issues.\n\nQueryability and Authorization (QAPs - Rules are not Filters) are supported by segregating data based on its security posture:\n\n1.  **Globally Accessible (with Role-Based Write):** Collections like `/medicine_compositions`, `/medicines`, and `/batches` are designed to be globally readable by all authenticated 'Admin' users. Write access to these collections is restricted to 'Admin' users only. This homogeneous security posture allows for efficient `list` queries (e.g., listing all medicines) without requiring complex `where` clauses for authorization, as the rules already ensure only authorized users can perform these operations.\n\n2.  **User-Owned/Context-Specific Data:** Collections such as `/sales` and `/stock_adjustment_logs` contain a `createdByUserId` or similar field explicitly linking them to the creating user (Admin). For example, an 'Admin' can `list` their own sales from `/sales` because the rules will enforce `request.auth.uid == resource.data.createdByUserId` for write operations and allow reads for specific users or admins globally. This design ensures that a user can only access documents they are authorized for directly through a field in the document, without filtering the query results in the rules.\n\n3.  **Customer Management:** `/customers` is a top-level collection managed by 'Admin', with reads for all authenticated users. `CustomerAccountTransaction`s are subcollections under a specific customer, containing `createdByUserId` to track which Admin processed the transaction."
  }
}
