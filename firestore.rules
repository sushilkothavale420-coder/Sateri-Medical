/**
 * Sateri Medical - Firestore Security Rules (Prototyping Mode)
 *
 * Core Philosophy:
 * This ruleset implements a simplified access control model for prototyping.
 * Any authenticated user is considered an 'Admin' and has broad control over
 * all data. This avoids the need for explicit role management in the database
 * or custom claims during early development.
 *
 * Data Structure:
 * The data is organized into top-level collections for major entities (e.g.,
 * /medicines, /suppliers, /sales). This flat structure simplifies rule logic and
 * queries. Subcollections are used for items that are tightly coupled to a parent
 * document, such as /sales/{saleId}/sale_items.
 *
 * Key Security Decisions:
 * - Default Deny: All access is denied by default. Rules only grant explicit permissions.
 * - Admin by Authentication: Any signed-in user is treated as an Admin.
 * - Public Write for Requests: A specific collection is open for public writes to allow
 *   unauthenticated users to submit medicine requests.
 * - Immutability: Critical relational fields like a creator's ID (`createdByUserId`)
 *   are enforced as immutable after creation to maintain data integrity.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
      * Checks if a document exists before an operation.
      */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Returns true if the authenticated user is an Admin.
     * For this prototype, any signed-in user is considered an Admin.
     * This unblocks the UI for both reads and writes but is not secure for production.
     * A production-ready solution would use custom claims or a role document.
     */
    function isAdmin() {
      return isSignedIn();
    }


    /**
     * Validates that the creator ID in a new document matches the authenticated user.
     */
    function isCreator(fieldName) {
      return request.resource.data[fieldName] == request.auth.uid;
    }

    /**
     * Validates that an ownership field has not been changed during an update.
     */
    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }
    
    /**
     * Validates that a user is the owner of an existing document.
     */
    function isExistingOwner(ownerId) {
      return isExistingDoc() && isOwner(ownerId);
    }

    // -------------------------------------------------------------------------
    // User Management
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profiles. Only Admin can manage users.
     * @path /users/{userId}
     * @allow (create, list, delete) Admin can manage all user profiles.
     * @allow (get, update) An existing user can read/update their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Core Inventory & Supplier Data (Admin Write, Authenticated Read)
    // -------------------------------------------------------------------------

    /**
     * @description Generic chemical compositions. Managed by Admins, readable by all users.
     */
    match /medicine_compositions/{compositionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Specific medicine products. Managed by Admins, readable by all users.
     */
    match /medicines/{medicineId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Individual batches of medicine. Managed by Admins, readable by all users.
     */
    match /batches/{batchId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Supplier information. Managed by Admins, readable by all users.
     */
    match /suppliers/{supplierId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Procurement (Admin Only)
    // -------------------------------------------------------------------------

    /**
     * @description Purchase orders and all related items. Fully managed by Admins.
     */
    match /purchase_orders/{document=**} {
      allow read, write: if isAdmin();
    }

    /**
     * @description Records for returning medicine to vendors and all related items. Fully managed by Admins.
     */
    match /returns_to_vendor/{document=**} {
      allow read, write: if isAdmin();
    }


    // -------------------------------------------------------------------------
    // Customer and Sales Management
    // -------------------------------------------------------------------------

    /**
     * @description Customer records. Managed by Admins, readable by all signed-in users.
     */
    match /customers/{customerId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
      
      /**
       * @description Customer financial transactions. Only Admins can manage.
       */
      match /transactions/{transactionId} {
        allow get, list: if isSignedIn();
        allow create: if isCreator('createdByUserId') && isAdmin() && exists(/databases/$(database)/documents/customers/$(customerId));
        allow update: if isExistingOwner(resource.data.createdByUserId) && isImmutable('createdByUserId') && isAdmin();
        allow delete: if isExistingOwner(resource.data.createdByUserId) && isAdmin();
      }
    }

    /**
     * @description Sales records. Admins manage all sales.
     */
    match /sales/{saleId} {
      allow get, list: if isAdmin();
      allow create: if isCreator('createdByUserId') && isAdmin();
      allow update: if isAdmin() && isImmutable('createdByUserId');
      allow delete: if isAdmin();

      /**
       * @description Items within a sale.
       */
      match /sale_items/{saleItemId} {
        allow get, list: if isAdmin();
        allow create, update, delete: if isAdmin();
      }
    }
    
    // -------------------------------------------------------------------------
    // Public Medicine Requests
    // -------------------------------------------------------------------------
    
    /**
     * @description Public-facing medicine requests. Anyone can create. Admin can manage.
     */
    match /public_medicine_requests/{requestId} {
      allow create: if true;
      allow get, list, update, delete: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Auditing and Collaboration
    // -------------------------------------------------------------------------

    /**
     * @description Immutable log of stock changes. Create-only for admin, read-only for Admins.
     */
    match /stock_adjustment_logs/{logId} {
      allow get, list: if isAdmin();
      allow create: if isCreator('adjustedByUserId') && isAdmin();
      allow update: if false;
      allow delete: if false;
    }
    
    // -------------------------------------------------------------------------
    // Collection Group Rules
    // -------------------------------------------------------------------------
    /**
     * @description Allows collection group query on sale_items for dashboard analytics.
     */
    match /{path=**}/sale_items/{saleItemId} {
       allow list: if isAdmin();
    }
  }
}
