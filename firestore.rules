/**
 * Sateri Medical - Firestore Security Rules (Prototyping Mode)
 *
 * Core Philosophy:
 * This ruleset implements a strict Role-Based Access Control (RBAC) model.
 * There is one primary Admin identified by a specific UID and a 'Retailer' role,
 * defined in a user's profile document in the `/users` collection. The Admin has
 * broad control over core business data, while Retailers have permissions
 * focused on transactional data they create.
 *
 * Data Structure:
 * The data is organized into top-level collections for major entities (e.g.,
 * /medicines, /suppliers, /sales). This flat structure simplifies rule logic and
 * queries. Subcollections are used for items that are tightly coupled to a parent
 * document, such as /sales/{saleId}/items.
 *
 * Key Security Decisions:
 * - Default Deny: All access is denied by default. Rules only grant explicit permissions.
 * - Admin by UID: A specific user UID is designated as the Admin.
 * - Retailer by Role: The 'Retailer' role is fetched from their /users/{userId} document.
 * - Admin Supremacy: The Admin has read access to almost all data and write access
 *   to core inventory, procurement, and user collections.
 * - Retailer Permissions: Retailers can read shared data like the medicine catalog
 *   but can only create/manage their own sales records.
 * - Immutability: Critical relational fields like a creator's ID (`createdByUserId`)
 *   are enforced as immutable after creation to maintain data integrity.
 *
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // -------------------------------------------------------------------------
    // Helper Functions
    // -------------------------------------------------------------------------

    /**
     * Returns true if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Returns true if the requesting user's UID matches the provided userId.
     */
    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    /**
      * Checks if a document exists before an operation.
      */
    function isExistingDoc() {
      return resource != null;
    }

    /**
     * Returns the user's role from their document in the /users collection.
     */
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    /**
     * Returns true if the authenticated user is the designated Admin.
     */
    function isAdmin() {
      return isSignedIn() && request.auth.uid == 'a6jWnMQZfLY82mBA3g0DIMxYRFZ2';
    }

    /**
     * Returns true if the authenticated user has the 'Retailer' role.
     */
    function isRetailer() {
      return isSignedIn() && getUserRole() == 'Retailer';
    }

    /**
     * Validates that the creator ID in a new document matches the authenticated user.
     */
    function isCreator(fieldName) {
      return request.resource.data[fieldName] == request.auth.uid;
    }

    /**
     * Validates that an ownership field has not been changed during an update.
     */
    function isImmutable(fieldName) {
      return request.resource.data[fieldName] == resource.data[fieldName];
    }
    
    /**
     * Validates that a user is the owner of an existing document.
     */
    function isExistingOwner(ownerId) {
      return isExistingDoc() && isOwner(ownerId);
    }

    // -------------------------------------------------------------------------
    // User Management
    // -------------------------------------------------------------------------

    /**
     * @description Manages user profiles. Only Admin can create users.
     * @path /users/{userId}
     * @allow (create, list, delete) Admin can manage all user profiles.
     * @allow (get, update) An existing user can read/update their own profile.
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isAdmin();
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Core Inventory & Supplier Data (Admin Write, Authenticated Read)
    // -------------------------------------------------------------------------

    /**
     * @description Generic chemical compositions. Managed by Admins, readable by all users.
     */
    match /medicine_compositions/{compositionId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Specific medicine products. Managed by Admins, readable by all users.
     */
    match /medicines/{medicineId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Individual batches of medicine. Managed by Admins, readable by all users.
     */
    match /batches/{batchId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Supplier information. Managed by Admins, readable by all users.
     */
    match /suppliers/{supplierId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    // -------------------------------------------------------------------------
    // Procurement (Admin Only)
    // -------------------------------------------------------------------------

    /**
     * @description Purchase orders to suppliers. Fully managed by Admins.
     */
    match /purchase_orders/{purchaseOrderId} {
      allow get, list, create, update, delete: if isAdmin();

      /**
       * @description Items within a purchase order.
       */
      match /items/{purchaseOrderItemId} {
        allow get, list: if isAdmin();
        allow create, update, delete: if isAdmin() && exists(/databases/$(database)/documents/purchase_orders/$(purchaseOrderId));
      }
    }

    /**
     * @description Records for returning medicine to vendors. Fully managed by Admins.
     */
    match /returns_to_vendor/{returnToVendorId} {
      allow get, list, create, update, delete: if isAdmin();

      /**
       * @description Items being returned to a vendor.
       */
      match /items/{returnToVendorItemId} {
        allow get, list: if isAdmin();
        allow create, update, delete: if isAdmin() && exists(/databases/$(database)/documents/returns_to_vendor/$(returnToVendorId));
      }
    }

    // -------------------------------------------------------------------------
    // Customer and Sales Management
    // -------------------------------------------------------------------------

    /**
     * @description Customer records. Managed by Admins, readable by all users.
     */
    match /customers/{customerId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
      
      /**
       * @description Customer financial transactions.
       */
      match /transactions/{transactionId} {
        allow get, list: if isSignedIn();
        allow create: if isCreator('createdByUserId') && (isRetailer() || isAdmin()) && exists(/databases/$(database)/documents/customers/$(customerId));
        allow update: if isExistingOwner(resource.data.createdByUserId) && isImmutable('createdByUserId');
        allow delete: if isExistingOwner(resource.data.createdByUserId);
      }
    }

    /**
     * @description Sales records. Retailers manage their own, Admins can read all.
     */
    match /sales/{saleId} {
      allow get: if isAdmin() || isExistingOwner(resource.data.createdByUserId);
      allow list: if isAdmin();
      allow create: if isCreator('createdByUserId') && (isRetailer() || isAdmin());
      allow update: if isExistingOwner(resource.data.createdByUserId) && isImmutable('createdByUserId');
      allow delete: if isExistingOwner(resource.data.createdByUserId);

      /**
       * @description Items within a sale.
       */
      match /sale_items/{saleItemId} {
        allow read: if isSignedIn();

        function canAccessParentSale() {
          let parentSale = get(/databases/$(database)/documents/sales/$(saleId)).data;
          return isAdmin() || isOwner(parentSale.createdByUserId);
        }
        
        allow create, update, delete: if canAccessParentSale();
      }
    }

    // -------------------------------------------------------------------------
    // Auditing and Collaboration
    // -------------------------------------------------------------------------

    /**
     * @description Immutable log of stock changes. Create-only for users, read-only for Admins.
     */
    match /stock_adjustment_logs/{logId} {
      allow get, list: if isAdmin();
      allow create: if isCreator('adjustedByUserId') && (isRetailer() || isAdmin());
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Requests between users (Admin/Retailer).
     */
    match /requests/{requestId} {
      function isParticipant() {
        return isOwner(resource.data.requesterUserId) || isOwner(resource.data.responderUserId);
      }

      allow get: if isParticipant();
      allow list: if false;
      allow create: if isCreator('requesterUserId') && (isRetailer() || isAdmin());
      allow update: if isExistingDoc() && isParticipant() && isImmutable('requesterUserId');
      allow delete: if false;
    }
  }
}

    